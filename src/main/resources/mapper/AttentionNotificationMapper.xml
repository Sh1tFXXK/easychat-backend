<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.example.easychat.Mapper.AttentionNotificationMapper">
    
    <!-- 获取用户的通知列表 -->
    <select id="getNotificationsByUserId" resultType="org.example.easychat.Entity.AttentionNotification">
        SELECT id, user_id, target_user_id, notification_type, content, is_read, create_time
        FROM attention_notifications 
        WHERE user_id = #{userId}
        <if test="isRead != null">
            AND is_read = #{isRead}
        </if>
        ORDER BY create_time DESC
        <if test="limit != null and offset != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>
    
    <!-- 批量标记通知为已读 -->
    <update id="batchMarkAsRead">
        UPDATE attention_notifications 
        SET is_read = 1
        WHERE user_id = #{userId}
        <if test="notificationIds != null and notificationIds.size() > 0">
            AND id IN
            <foreach collection="notificationIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
    </update>
    
    <!-- 获取未读通知数量 -->
    <select id="getUnreadCount" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM attention_notifications 
        WHERE user_id = #{userId} 
        AND is_read = 0
    </select>
    
    <!-- 清理过期通知 -->
    <delete id="cleanExpiredNotifications">
        DELETE FROM attention_notifications 
        WHERE create_time &lt; #{before}
    </delete>
    
    <!-- 根据类型获取通知 -->
    <select id="getNotificationsByType" resultType="org.example.easychat.Entity.AttentionNotification">
        SELECT id, user_id, target_user_id, notification_type, content, is_read, create_time
        FROM attention_notifications 
        WHERE user_id = #{userId} 
        AND notification_type = #{notificationType}
        ORDER BY create_time DESC
        <if test="limit != null and offset != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>
    
    <!-- 删除用户的所有通知 -->
    <delete id="deleteAllByUserId">
        DELETE FROM attention_notifications 
        WHERE user_id = #{userId}
    </delete>
</mapper>